# 石头剪刀布游戏 - 用户交互流程（更新版）

本文档描述了石头剪刀布智能合约游戏中各角色的交互流程，包括游戏创建者、加入者和管理员的操作步骤。

## 1. 玩家角色

### 1.1 玩家A（游戏创建者）

#### ETH游戏模式

1. **创建游戏**
   - 确定游戏回合数（必须是奇数）
   - 设置揭示阶段超时时间（至少5分钟）
   - 设置提交阶段超时时间（至少5分钟）
   - 确定投注金额（以ETH为单位）
   - 调用`createGameWithEth`函数并附上对应ETH
   - 获取并记录生成的游戏ID

2. **等待玩家加入**
   - 等待另一玩家加入游戏
   - 如果超过加入截止时间（joinDeadline）无人加入，可以调用`timeoutJoin`函数取消游戏并收回ETH

3. **进行游戏回合**
   - 当玩家B加入后，游戏自动进入提交阶段（CommitPhase）
   - 每回合有两个阶段：提交阶段和揭示阶段
   
4. **提交移动**
   - 选择移动（石头、剪刀或布）
   - 当有一名玩家提交了移动，则设置`commitDeadline`开始计时
   - 玩家自定或生成随机盐值并本地保存
   - 使用移动、盐值和自己的地址生成哈希
   - 调用`commitMove`函数提交哈希
   - 如果对手在提交截止时间前未提交，可以调用`timeoutCommit`函数赢得本次游戏

5. **揭示移动**
   - 等待双方都提交移动后，游戏状态自动转为已提交（Committed），并自动设置`revealDeadline`，开始计时。
   - 使用之前保存的盐值和原始移动调用`revealMove`函数，如本地没有未找到盐值则手动输入
   - 如果对手在揭示截止时间前未揭示，可以调用`timeoutReveal`函数

6. **查看回合结果**
   - 当双方都揭示了移动或超时处理后，游戏状态转为已揭示（Revealed）
   - 系统会确定回合赢家
   - 游戏会自动进入下一回合的提交阶段或结束游戏（接下去状态可能的去向：CommitPhase, Finished）

7. **提取奖金**
   - 当累计赢得足够回合数成为游戏赢家后
   - 游戏自动结束并将奖金分配给赢家
   - 赢家调用`withdrawPrize`函数提取ETH奖金
   - 赢家会额外获得一枚WinningToken代币

#### 代币游戏模式

1. **创建游戏**
   - 确保拥有WinningToken代币
   - 批准合约使用代币
   - 调用`createGameWithToken`函数创建游戏（需传入游戏回合数、揭示超时和提交超时参数）
   - 获取并记录生成的游戏ID

2. **后续步骤**
   - 与ETH模式相同，但不涉及ETH转账
   - 游戏结束后，赢家将获得双方的代币，共2个代币

### 1.2 玩家B（游戏加入者）

#### ETH游戏模式

1. **加入游戏**
   - 找到待加入的游戏ID
   - 查询游戏信息获取投注金额
   - 调用`joinGameWithEth`函数并附上相同金额的ETH

2. **进行游戏回合**
   - 游戏进入提交阶段（CommitPhase）
   - 后续流程与玩家A相同（提交移动、揭示移动等）

3. **提取奖金**
   - 如果成为游戏赢家，调用`withdrawPrize`函数提取ETH奖金
   - 也可以通过`getPendingWithdrawals`函数查询可提取的奖励金额

#### 代币游戏模式

1. **加入游戏**
   - 确保拥有WinningToken代币
   - 批准合约使用代币
   - 调用`joinGameWithToken`函数加入游戏

2. **后续步骤**
   - 与ETH模式相同，但不涉及ETH转账
   - 游戏结束后，如果赢得游戏，可获得双方的代币，共2个代币

## 2. 管理员角色

1. **设置新管理员**
   - 当前管理员可以调用`setAdmin`函数设置新管理员

2. **更新加入超时时间**
   - 调用`setJoinTimeout`函数更新默认的玩家加入超时时间

3. **提取协议费用**
   - 所有游戏收取的协议费用（占总投注额的10%）累积在合约中
   - 管理员可以调用`withdrawFees`函数提取指定数量的费用
   - 或使用`withdrawAllFunds`函数紧急提取合约中的所有资金（谨慎使用）

## 3. 游戏状态流转图

```
创建(Created) 
    ↓
玩家B加入
    ↓
提交阶段(CommitPhase) ← 可能出现timeoutCommit（如有玩家未提交）
    ↓
双方提交后 → 已提交(Committed) ← 可能出现timeoutReveal（如有玩家未揭示）
    ↓
双方揭示后 → 已揭示(Revealed)
    ↓
回合结束，游戏未完成 → 提交阶段(CommitPhase) [新回合]
    ↓
游戏完成 → 已结束(Finished)
```

## 4. 异常流程处理

1. **加入超时**
   - 如果创建游戏后无人在期限内加入，创建者可调用`timeoutJoin`函数取消游戏
   - 投注金额将返还给创建者,游戏状态变为Cancelled
   - 可以通过`canTimeoutJoin`函数检查是否可以执行加入超时操作

2. **提交超时**
   - 如果在提交阶段（CommitPhase）对手未在规定时间内提交移动，已提交的玩家可以调用`timeoutCommit`函数
   - 超时后，已提交玩家将赢得本游戏
   - 可以通过`canTimeoutCommit`函数检查是否可以执行提交超时操作

3. **揭示超时**
   - 如果在已提交状态（Committed）对手未在规定时间内揭示移动，已揭示的玩家可以调用`timeoutReveal`函数
   - 超时后，已揭示玩家将赢得本游戏，都未揭示则取消游戏
   - 可以通过`canTimeoutReveal`函数检查是否可以执行揭示超时操作

4. **主动取消游戏**
   - 在玩家B加入之前，创建者可以通过`cancelGame`函数取消游戏
   - 取消后，投注金额将返还给创建者
   - 在平局或提交揭示超时双方如都未提交，则返还金额或代币给双方各自账户

## 5. 完整游戏示例

### 使用ETH的回合制游戏

1. 玩家A创建3回合游戏，投注0.1 ETH
   - 设置揭示超时为10分钟
   - 设置提交超时为10分钟

2. 玩家B加入游戏，也投注0.1 ETH
   - 游戏状态变为CommitPhase

3. 回合1：
   - A提交移动（石头），此时`commitDeadline`被设置
   - B提交移动（剪刀）
   - 双方都提交后，游戏状态变为Committed，此时`revealDeadline`被设置
   - A揭示移动
   - B揭示移动
   - 游戏状态变为Revealed
   - A赢得回合1，得分A:1, B:0
   - 游戏自动进入下一回合的CommitPhase,并重置相关Deadline为0

4. 回合2：
   - A提交移动（布），此时`commitDeadline`被设置
   - B提交移动（剪刀）
   - 双方都提交后，游戏状态变为Committed，此时`revealDeadline`被设置
   - A揭示移动
   - B揭示移动
   - 游戏状态变为Revealed
   - B赢得回合2，得分A:1, B:1
   - 游戏自动进入下一回合的CommitPhase,并重置相关Deadline为0

5. 回合3：
   - A提交移动（石头），此时`commitDeadline`被设置
   - B提交移动（剪刀）
   - 双方都提交后，游戏状态变为Committed，此时`revealDeadline`被设置
   - A揭示移动
   - B揭示移动
   - 游戏状态变为Revealed
   - A赢得回合3，得分A:2, B:1

6. 游戏结束，A是赢家
   - 游戏状态变为Finished
   - 奖金金额为0.18 ETH（0.2 ETH总额 - 0.02 ETH协议费）

7. A调用`withdrawPrize`提取奖金

### 异常情况示例

1. **提交超时情况**:
   - 玩家A创建游戏并设置提交超时为10分钟
   - 玩家B加入游戏
   - 玩家A提交移动
   - 玩家B未在10分钟内提交
   - 玩家A调用`canTimeoutCommit`确认可以超时
   - 玩家A调用`timeoutCommit`直接跳过后续回合赢得游戏

2. **揭示超时情况**:
   - 双方都提交了移动
   - 玩家A揭示移动
   - 玩家B未在揭示时间内揭示
   - 玩家A调用`canTimeoutReveal`确认可以超时
   - 玩家A调用`timeoutReveal`直接跳过后续回合赢得游戏

3. **都未揭示超时情况**
   - 双方都提交了移动
   - 双方都未在揭示时间（双方都提交时自动开始）内揭示
   - 任意玩家可调用`canTimeoutReveal`确认可以超时
   - 任意玩家调用`timeoutReveal`取消当前游戏
