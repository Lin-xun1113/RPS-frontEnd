# 石头剪刀布游戏 - 用户交互流程

本文档描述了石头剪刀布智能合约游戏中各角色的交互流程，包括游戏创建者、加入者和管理员的操作步骤。

## 1. 玩家角色

### 1.1 玩家A（游戏创建者）

#### ETH游戏模式

1. **创建游戏**
   - 确定游戏回合数（必须是奇数）
   - 设置超时时间（至少5分钟）
   - 确定投注金额（以ETH为单位）
   - 调用`createGameWithEth`函数并附上对应ETH
   - 获取并记录生成的游戏ID

2. **等待玩家加入**
   - 等待另一玩家加入游戏
   - 如果超过加入截止时间（joinDeadline）无人加入，可以调用`timeoutJoin`函数取消游戏并收回ETH

3. **进行游戏回合**
   - 当玩家B加入后，游戏自动开始第一回合
   - 每回合有两个阶段：提交阶段和揭示阶段
   
4. **提交移动**
   - 选择移动（石头、剪刀或布）
   - 生成随机盐值并本地保存
   - 使用移动、盐值和自己的地址生成哈希
   - 调用`commitMove`函数提交哈希

5. **揭示移动**
   - 等待双方都提交移动后
   - 使用之前保存的盐值和原始移动调用`revealMove`函数
   - 如果对手在揭示截止时间前未揭示，可以调用`timeoutReveal`函数

6. **查看回合结果**
   - 当双方都揭示了移动或超时处理后，系统会确定回合赢家
   - 游戏会自动进入下一回合或结束游戏

7. **提取奖金**
   - 当累计赢得足够回合数成为游戏赢家后
   - 游戏自动结束并将奖金分配给赢家
   - 赢家调用`withdrawPrize`函数提取ETH奖金
   - 赢家会额外获得一枚WinningToken代币

#### 代币游戏模式

1. **创建游戏**
   - 确保拥有WinningToken代币
   - 批准合约使用代币
   - 调用`createGameWithToken`函数创建游戏
   - 获取并记录生成的游戏ID

2. **后续步骤**
   - 与ETH模式相同，但不涉及ETH转账
   - 游戏结束后，赢家将获得双方的代币，共2个代币

### 1.2 玩家B（游戏加入者）

#### ETH游戏模式

1. **加入游戏**
   - 找到待加入的游戏ID
   - 查询游戏信息获取投注金额
   - 调用`joinGameWithEth`函数并附上相同金额的ETH

2. **进行游戏回合**
   - 游戏自动开始第一回合
   - 后续流程与玩家A相同（提交移动、揭示移动等）

3. **提取奖金**
   - 如果成为游戏赢家，调用`withdrawPrize`函数提取ETH奖金

#### 代币游戏模式

1. **加入游戏**
   - 确保拥有WinningToken代币
   - 批准合约使用代币
   - 调用`joinGameWithToken`函数加入游戏

2. **后续步骤**
   - 与ETH模式相同，但不涉及ETH转账
   - 游戏结束后，如果赢得游戏，可获得双方的代币，共2个代币

## 2. 管理员角色

1. **设置新管理员**
   - 当前管理员可以调用`setAdmin`函数设置新管理员

2. **更新加入超时时间**
   - 调用`setJoinTimeout`函数更新默认的玩家加入超时时间

3. **提取协议费用**
   - 所有游戏收取的协议费用（占总投注额的2%）累积在合约中
   - 管理员可以调用`withdrawFees`函数提取指定数量的费用
   - 或使用`withdrawAllFunds`函数紧急提取合约中的所有资金（谨慎使用）

## 3. 游戏状态流转图

```
创建(Created) 
    ↓
玩家B加入
    ↓
提交阶段(CommitPhase)
    ↓
双方提交后 → 已提交(Committed)
    ↓
双方揭示后 → 已揭示(Revealed)
    ↓
回合结束，游戏未完成 → 提交阶段(CommitPhase) [新回合]
    ↓
游戏完成 → 已结束(Finished)
```

## 4. 异常流程处理

1. **加入超时**
   - 如果创建游戏后无人在期限内加入，创建者可调用`timeoutJoin`取消游戏
   - 投注金额将返还给创建者

2. **揭示超时**
   - 如果对手在提交移动后未在期限内揭示，另一方可调用`timeoutReveal`函数
   - A、B双方始终由先提交移动的玩家先开始超时倒计时
   - 超时后，诚实玩家将赢得当前回合

3. **主动取消游戏**
   - 在玩家B加入之前，创建者可以通过`cancelGame`函数取消游戏
   - 取消后，投注金额将返还给创建者

## 5. 完整游戏示例

### 使用ETH的回合制游戏

1. 玩家A创建3回合游戏，投注0.1 ETH
2. 玩家B加入游戏，也投注0.1 ETH
3. 回合1：
   - A提交移动（石头）
   - B提交移动（剪刀）
   - A揭示移动
   - B揭示移动
   - A赢得回合1，得分A:1, B:0
4. 回合2：
   - A提交移动（布）
   - B提交移动（剪刀）
   - A揭示移动
   - B揭示移动
   - B赢得回合2，得分A:1, B:1
5. 回合3：
   - A提交移动（石头）
   - B提交移动（剪刀）
   - A揭示移动
   - B揭示移动
   - A赢得回合3，得分A:2, B:1
6. 游戏结束，A是赢家
7. A调用`withdrawPrize`提取奖金（0.196 ETH = 0.2 ETH总额 - 0.004 ETH协议费）
